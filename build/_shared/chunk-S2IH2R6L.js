import{a as C,b as D,c as q,d as Q,e as E}from"/censys/build/_shared/chunk-5B22H335.js";import{b as J}from"/censys/build/_shared/chunk-3JU625ZU.js";import{b as K}from"/censys/build/_shared/chunk-RAMDI2JB.js";import{F as X}from"/censys/build/_shared/chunk-W5Y6TOHF.js";import{f as k}from"/censys/build/_shared/chunk-FH7VNUY3.js";import{A as Y,B as $,C as P,Ta as F,aa as _}from"/censys/build/_shared/chunk-UYH4GQ7Z.js";import{d as H}from"/censys/build/_shared/chunk-6URBRDCL.js";import{a as O,c as y}from"/censys/build/_shared/chunk-XJAPXWKX.js";import{d as A}from"/censys/build/_shared/chunk-2QEWK57A.js";var p=A(O(),1);var c=A(O(),1);var v=A(O(),1);function Z(){let[e,r]=(0,v.useState)(!0);return(0,v.useEffect)(()=>{let t=()=>r(document.visibilityState==="visible");return document.addEventListener("visibilitychange",t),()=>{document.removeEventListener("visibilitychange",t)}},[]),{isVisible:e}}function j(e,r={}){let t=k(),{intervalMs:n=6e4,autoStart:m=!1}=r,{isVisible:R}=Z(),[s,u]=(0,c.useState)(0),[g,i]=(0,c.useState)(null),[f,S]=(0,c.useState)(null),o=(0,c.useRef)(null),a=(0,c.useRef)(null),l=(0,c.useRef)(!1),N=(0,c.useRef)(0),T=(0,c.useCallback)(async()=>{if(!R||Date.now()-N.current<n)return;a.current&&a.current?.abort();let ut=a.current;a.current=new AbortController,u(3);try{let L=await J(e,a.current,t?.organizationId,{priority:"low"});if(!L)return;let{data:z,res:lt}=L;lt.ok?(i(z),S(null),u(1)):(S(z),u(2))}catch(L){ut?.signal.aborted||(S(L),u(2))}N.current=Date.now(),l.current&&(o.current!==null&&window.clearTimeout(o.current),o.current=window.setTimeout(T,n))},[e,t?.organizationId,R,n]),d=(0,c.useCallback)(()=>{l.current||(T(),l.current=!0)},[T]),W=(0,c.useCallback)(()=>{l.current=!1,o.current!==null&&(window.clearTimeout(o.current),o.current=null),s===3&&u(0)},[s]);return(0,c.useEffect)(()=>{l.current&&W(),m&&s===0&&R&&d()},[m,R]),(0,c.useEffect)(()=>{o.current!==null&&(window.clearTimeout(o.current),o.current=null),l.current&&(o.current=window.setTimeout(T,n))},[n]),(0,c.useEffect)(()=>()=>{o.current!==null&&window.clearTimeout(o.current),a.current?.abort()},[]),{data:g,error:f,state:s,start:d,stop:W}}var x={idle:60*1e3,scanning:7*1e3},tt=H.coerce.number().min(q).max(Q),w={[31e4]:"Unable to determine concurrent scan status. Refresh and try again.",[310001]:"You have reached the maximum number of concurrent scans.",[100002]:"Unable to obtain consumption balance. Refresh and try again.",[100001]:"You do not have enough credits to perform this scan.",[100005]:"Invalid CSRF token. Refresh and try again.",[100006]:"Invalid form data. Refresh and try again.",[1e5]:"Failed to initialize port scan.",[110001]:"Organization ID mismatch.",[11e4]:"Organization not found.",[310002]:"This asset is blocklisted and can't be scanned. Try a different asset."};var B=(n=>(n.LOADING="LOADING",n.SUCCESS="SUCCESS",n.ERROR="ERROR",n))(B||{});function et(e,r){switch(r.type){case"SET_ACTIONS":{let t=M(r.payload);return{...e,trackedScans:r.payload,status:t}}case"SET_ERROR":return{...e,status:"ERROR"};case"OPTIMISTIC_UPDATE":return{...e,status:"LOADING",trackedScans:r.payload?[...e.trackedScans??[],r.payload]:e.trackedScans};default:return e}}function M(e){if(!e.length)return null;if(e.some(t=>!t.completed))return"LOADING";let r=e.flatMap(t=>t.tasks);return r.some(t=>t.status===C.TrackedScan_Task_Status.REJECTED||t.status===C.TrackedScan_Task_Status.TIMED_OUT||t.status===C.TrackedScan_Task_Status.UNKNOWN)?"ERROR":r.some(t=>t.status===C.TrackedScan_Task_Status.SCANNING)?"LOADING":r.every(t=>t.status===C.TrackedScan_Task_Status.COMPLETED||t.status===C.TrackedScan_Task_Status.SCANNED||t.status===C.TrackedScan_Task_Status.IGNORED)?"SUCCESS":null}function rt(e){if(!e)return x.idle;switch(e){case"LOADING":return x.scanning;case"ERROR":case"SUCCESS":default:return x.idle}}function U(e,r){let t=e.target;return t?.hostPort?.ip===r||t?.hostnamePort?.hostname===r||t?.webOrigin?.hostname===r||t?.serviceId?.ip===r}function nt(e,r){let t=e.target;return t?.hostPort?.port===r||t?.hostnamePort?.port===r||t?.webOrigin?.port===r||t?.serviceId?.port===r}function ot(e){return e.target?.hostPort!==void 0||e.target?.hostnamePort!==void 0}var at=A(y(),1),G=(0,p.createContext)(void 0);function pt({children:e,pollingEnabled:r=!1,apiEndpoint:t=D}){let[n,m]=(0,p.useReducer)(et,{trackedScans:null,status:null}),R=rt(n.status),{data:s,start:u,stop:g}=j(()=>t,{intervalMs:R,autoStart:r});(0,p.useEffect)(()=>{if(s){if("code"in s){m({type:"SET_ERROR"});return}m({type:"SET_ACTIONS",payload:s.backgroundActions})}},[s]),(0,p.useEffect)(()=>{r?u():g()},[r,u,g]);let i=(0,p.useCallback)(a=>{m({type:"OPTIMISTIC_UPDATE",payload:a})},[]),f=(0,p.useCallback)((a,l)=>{let N=M(n.trackedScans??[])==="LOADING",T=d=>U(d,a)&&(l?nt(d,l):!0)&&N;return n.trackedScans?.some(T)??!1},[n.trackedScans]),S=(0,p.useCallback)(a=>n.trackedScans?.some(l=>ot(l)&&U(l,a)&&M(n.trackedScans??[])==="LOADING")??!1,[n.trackedScans]),o=(0,p.useMemo)(()=>({trackedScans:n.trackedScans,status:n.status,isAssetBeingScanned:f,isPerformingDiscoveryScanOnAsset:S,optimisticallyUpdate:i}),[n.trackedScans,n.status,f,S,i]);return(0,at.jsx)(G.Provider,{value:o,children:e})}function b(){let e=(0,p.useContext)(G);if(e===void 0)throw new Error("useBackgroundActionContext must be used within a BackgroundActionProvider");return e}var I=A(O(),1);function it({isScanInProgress:e,entityId:r,port:t,protocol:n,transportProtocol:m,rescanResourceType:R,scanTime:s}){let{optimisticallyUpdate:u}=b(),g=K(),i=X(),f=k(),[S,o]=(0,I.useState)(null),a=(0,I.useMemo)(()=>tt.safeParse(t),[t]),l=(0,I.useMemo)(()=>i.state==="submitting"||i.state==="loading",[i.state]);(0,I.useEffect)(()=>{if(i.data){if("code"in i.data){let T=w[i.data.code];o(T??w[1e5]);return}u(i.data??null)}},[i.data]);let N=(0,I.useCallback)(async T=>{if(T.preventDefault(),!a.success||e)return;o(null);let d=new FormData;d.set(E.CSRF_TOKEN,g),d.set(E.ORG_ID,f?.organizationId??""),d.set(E.PORT,a.data.toString()),d.set(E.RESOURCE_TYPE,R),d.set(E.ENTITY_ID,r),n&&d.set(E.PROTOCOL,n),m&&d.set(E.TRANSPORT_PROTOCOL,m),s&&d.set(E.SCAN_TIME,s),i.submit(d,{method:"POST",action:`${D}${f?.organizationId?`?org=${f?.organizationId}`:""}`})},[i,a,r,n,m,e]);return{isSubmitting:l,errorText:S,port:t,submit:N,Form:i.Form}}var ct=A(O(),1);var st="rescan-label";var V={scanInProgressBtn:"Ej71O",spin:"eTwf6",error:"SkvSM"};var h=A(y(),1);function mt({rescanResourceType:e,entityId:r,port:t,protocol:n,transportProtocol:m,scanTime:R,className:s}){let{status:u,isAssetBeingScanned:g}=b(),i=(0,ct.useMemo)(()=>g(r,parseInt(t)),[g,r,t,u]),{isSubmitting:f,submit:S,Form:o,errorText:a}=it({isScanInProgress:u==="LOADING",rescanResourceType:e,entityId:r,port:t,protocol:n,transportProtocol:m,scanTime:R}),l=u==="LOADING"&&i,N=f||u==="LOADING";return l?(0,h.jsx)(F,{content:"Live Rescan in Progress",triggerClassName:s,children:(0,h.jsx)(_,{variant:P.TERTIARY,iconLeft:"loader-4",iconLeftMode:"line",disabled:!0,"aria-label":"Live Rescan in Progress",className:V.scanInProgressBtn,children:"Rescanning..."})}):N?(0,h.jsx)(F,{content:"Another Live Rescan in Progress",triggerClassName:s,children:(0,h.jsx)(_,{variant:P.TERTIARY,iconLeft:"scan-2",iconLeftMode:"line",disabled:f||u==="LOADING",isLoading:f,className:s,"aria-label":`Rescan this asset on port ${t}`,children:"Live Rescan"})}):(0,h.jsxs)(o,{onSubmit:S,noValidate:!0,children:[(0,h.jsx)(_,{variant:P.TERTIARY,iconLeft:"scan-2",iconLeftMode:"line",className:s,"aria-label":`Rescan this asset on port ${t}`,children:"Live Rescan"}),a&&(0,h.jsx)($,{id:st,variant:Y.SMALL,className:V.error,role:"alert",children:a})]})}export{B as a,tt as b,pt as c,b as d,it as e,mt as f};
