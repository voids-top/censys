import{a as nt,b as lt,c as ct,d as pt,e as mt,f as ht,g as dt,h as gt}from"/censys/build/_shared/chunk-BN26CT6T.js";import{a as at,b as st}from"/censys/build/_shared/chunk-N2TESHV5.js";import{a as it}from"/censys/build/_shared/chunk-FZMSXVON.js";import{b as rt}from"/censys/build/_shared/chunk-VBURMR5K.js";import{a as j}from"/censys/build/_shared/chunk-YTHNDA7O.js";import{a as q}from"/censys/build/_shared/chunk-ULGJ3ZYU.js";import{k as X}from"/censys/build/_shared/chunk-IUMSQHOS.js";import{a as J}from"/censys/build/_shared/chunk-WNJFRA3F.js";import{a as Z}from"/censys/build/_shared/chunk-JAEJ7XSF.js";import{a as ot}from"/censys/build/_shared/chunk-QHRZ4J4F.js";import{e as tt,h as et}from"/censys/build/_shared/chunk-IO4OV3HV.js";import{a as Dt}from"/censys/build/_shared/chunk-IC5AY47K.js";import{a as z}from"/censys/build/_shared/chunk-LOKTUJJ3.js";import{a as W}from"/censys/build/_shared/chunk-BWODHJE6.js";import{e as Y,h as B}from"/censys/build/_shared/chunk-ST66DGSY.js";import{B as Q,x,z as V}from"/censys/build/_shared/chunk-QJVHIZ52.js";import{$ as G,A as L,B as I,xa as K,z as A}from"/censys/build/_shared/chunk-DN2SN5ZC.js";import{c as F}from"/censys/build/_shared/chunk-44DVAK2X.js";import{C as w,a as N,c as O,i as b,k as C,p as M}from"/censys/build/_shared/chunk-JMZ2MZXD.js";import{b as U}from"/censys/build/_shared/chunk-ZST4CTCB.js";import{a as At}from"/censys/build/_shared/chunk-MOHCJWAV.js";import{e as v}from"/censys/build/_shared/chunk-2TWE7TSA.js";var a=v(At(),1);var P={threatsLayout:"Kux5l",threatTimelineHeader:"_-1Jpf",serviceList:"f-D5Q"};var $t="ip",kt="port",_t="protocol",xt="transport_protocol",Nt="threat_name";function ut({port:s,protocol:m,transportProtocol:h}){return`${m} ${s} / ${h}`}function ft(s,m,h,d){if(!s)return{host:[]};let g={host:[]};for(let o of s){let l=o.startTime?.toString(),c=o.endTime?.toString();if(!l||!c)continue;let u=o.keys,p=u.get($t),f=u.get(kt),R=u.get(_t),T=u.get(xt),S=u.get(Nt);if(!p||!f||!R||!T||!S)continue;let $=ut({port:f,protocol:R,transportProtocol:T}),k={id:`${p}-${f}-${R}-${T}-${S}-${l}-${c}`,type:"host",name:$,startDate:l,endDate:c,subtitle:S,shape:X.ROUNDED,opacity:1};g.host.push(k)}let D=m.flatMap(o=>o.threats.map(l=>({service:o,threat:l}))),y=st(g.host,{entities:D,getName:({service:o})=>ut({port:o.port.toString(),protocol:o.protocol,transportProtocol:o.transport_protocol}),getSubtitle:({threat:o})=>o.name},h,d);return{...g,host:y}}var bt=v(Dt(),1),t=v(U(),1),ge=q("Host Threats","routes/hosts.$id");function Ot(){let s=O(),m=b(),{collection:h,host:d,threatDetails:g}=it(),[D]=M(),{historicalRanges:y,historicalRangesStart:o,historicalRangesEnd:l,historicalRangeLimit:c,filterError:u}=j(),p=w(),[f,R]=(0,a.useState)([]),[T,S]=(0,a.useState)(""),$=B("threat-history"),k=(0,a.useMemo)(()=>gt(c),[c]),H=`/hosts/${d.ip}`;h&&(H=`/collections/${h.collection_id}${H}`),(0,a.useEffect)(()=>{let i=Z(p.data),r=i?.historicalRanges?.ranges,n=i?.historicalRanges?.nextPageToken;r&&(R([...f,...r]),S(n??""))},[p.data]),(0,a.useEffect)(()=>{let i=y?.nextPageToken??"";R([]),S(i)},[y]);let _=(0,a.useMemo)(()=>{let i=new Map;for(let r of d.services)if(r.threats)for(let n of r.threats){let e=i.get(n.id);e?e[1].push(r):i.set(n.id,[n,[r]])}return Array.from(i.entries()).sort()},[d,g]),Tt=(0,a.useCallback)(()=>{if(p.state==="idle"){let i=new URLSearchParams(s.search);i.set(dt,T??""),p.load(`${s.pathname}?${i.toString()}`)}},[p,s.pathname,s.search,T]),yt=(0,a.useMemo)(()=>{let r=[...y?.ranges??[],...f];return ft(r,d.services,l,o)},[y,d.services,l,f]),Rt=(0,a.useMemo)(()=>Temporal.Now.zonedDateTimeISO("UTC").subtract({days:c}).startOfDay().toInstant(),[c]),St=m.state==="loading"&&m.location.pathname.endsWith("threats");return(0,t.jsxs)("div",{className:P.threatsLayout,children:[$&&(0,t.jsxs)(K,{header:(0,t.jsxs)("div",{className:P.threatTimelineHeader,children:[(0,t.jsx)(L,{variant:A.H4,children:"Threat Detection History"}),(0,t.jsx)(at,{schema:k,hostHistoryLimitDate:Rt,dateFields:{start:{key:ct,initialValue:o},end:{key:pt,initialValue:l}},filterFields:[{key:mt,label:"Port",placeholder:"Number",type:"number"},{key:ht,label:"Protocol",placeholder:"Protocol",type:"text"}]})]}),children:[(0,t.jsx)(rt,{timelineData:yt,historicalRangesStart:o,historicalRangesEnd:l,historicalRangeLimit:c,colors:[z.RED],isLoading:St,loadingHeight:"short",error:{filter:u}}),T&&(0,t.jsx)(G,{isLoading:p.state!=="idle",onClick:Tt,variant:I.TERTIARY,iconRight:"arrow-down",children:"Load More"})]}),_.length===0&&(0,t.jsx)(L,{children:"We haven't found any publicly accessible services with Threat(s) on this host or the host is on our blocklist."}),_.length>0&&_.map(([i,[r,n]])=>(0,t.jsx)(nt,{description:g?.[r.id]?.description,threat:r,addedAt:g?.[r.id]?.addedAt?.toString(),subHeader:n.length>0?(0,t.jsxs)(L,{variant:A.H5,children:[n.length," ",J("service",n.length)]}):null,baseRoute:H,children:(0,t.jsxs)("div",{children:[(0,t.jsxs)(L,{className:P.sectionHeader,variant:A.H4,children:["Services (",n.length,")"]}),(0,t.jsx)("ul",{className:P.serviceList,children:n.map(e=>{let Ht=`${e.protocol} ${e.port} / ${e.transport_protocol}`,Lt=D.toString(),Pt=et(e,H,Lt),Et=V(Q(x({kind:0,field:"host.services.threats.id",value:r.id}),x({kind:5,field:"host.services",content:`port = ${e.port} and protocol = ${e.protocol}`}),"and",!1)),vt=[{to:Pt,iconName:"arrow-right",label:"Go to service on host"},{to:Et,iconName:"search",label:"Search for threat on service"}];return(e.threats||[]).filter(E=>E.id===r.id).map(E=>(0,t.jsx)(lt,{threat:E,baseRoute:H,title:Ht,timestamp:e.scan_time?.toString(),actionLinks:vt,ariaLabel:`Threat details for service with protocol ${e.protocol} and port ${e.port}`,testId:`threat-detail-item-${E.id}-${e.ip}-${e.port}`},`${e.ip}-${e.port}`))})})]})},i))]})}function ue(){let s=C(),m=Y(),h=(0,a.useContext)(F);return(0,t.jsx)("div",{"data-testid":"host-threats-error",children:N(s)&&tt(s.data)?(0,t.jsx)(ot,{accessState:m,error:s.data,env:h}):(0,t.jsx)(W,{error:s})})}export{ge as a,Ot as b,ue as c};
